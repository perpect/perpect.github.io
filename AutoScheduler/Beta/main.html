<!-- shift_scheduler.html : Pure jQuery implementation -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>êµëŒ€ê·¼ë¬´ ì¼ì •ê´€ë¦¬</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>êµëŒ€ê·¼ë¬´ ì¼ì •ê´€ë¦¬</header>
  <nav>
    <button data-tab="setup" class="active">1ï¸âƒ£ ì„¤ì •</button>
    <button data-tab="generate">2ï¸âƒ£ ìƒì„±</button>
    <button data-tab="results">3ï¸âƒ£ ê²°ê³¼</button>
  </nav>

  <!-- 1. ì„¤ì • íƒ­ -->
  <section id="setup" class="tab active">
    <h2>ê·œì¹™ & ê¸°ë³¸ ì •ë³´</h2>

    <label>ì¸ì› ëª©ë¡ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
    <textarea id="peopleInput" placeholder="ì‚¬ëŒ1\nì‚¬ëŒ2\n..."></textarea>

    <h3>ê·œì¹™ ì„ íƒ</h3>
    <div id="ruleList"></div>

    <h3>ìµœì í™” ê¸°ì¤€</h3>
    <select id="optimSelect">
      <option value="MIN_MAX_GAP">ìµœëŒ€-ìµœì†Œ ê·¼ë¬´ì‹œê°„ ì°¨ì´ ìµœì†Œí™”</option>
      <option value="BALANCE_NIGHT">ì•¼ê°„ ê·¼ë¬´ ê· ë“± ë¶„ë°°</option>
    </select>

    <h3>í•„ìˆ˜ ì•¼ê·¼ ë‚ ì§œ (ì‰¼í‘œ êµ¬ë¶„)</h3>
    <input type="text" id="requiredNightsInput" placeholder="ì˜ˆ: 5,12,19" />
  </section>

  <!-- 2. ìƒì„± íƒ­ -->
  <section id="generate" class="tab">
    <h2>ìš”ì•½ & ìƒì„±</h2>
    <div id="summary"></div>
    <button id="generateBtn">ğŸ”„ ìƒì„±í•˜ê¸°</button>
    <div id="genStatus" style="margin-top:8px;"></div>
  </section>

  <!-- 3. ê²°ê³¼ íƒ­ -->
  <section id="results" class="tab">
    <h2>ê²°ê³¼</h2>
    <div id="scheduleTable"></div>
    <div id="statsBox" class="stats"></div>
  </section>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ -->
  <script type="module">
    import { DUTIES } from "./Duty.js";
    import { Schedule } from "./Schedule.js";
    import { solve } from "./Solver.js";
    import { NightAfterNightOffRule, EssentialDuty, NoConsecutiveOffRule, MinimalDutiesRule } from "./Rule.js";

    $(function(){
      /* ------------------------------ íƒ­ ì „í™˜ ------------------------------ */
      const $tabBtns = $("nav button");
      $tabBtns.on("click", function(){
        const tab = $(this).data("tab");
        $tabBtns.removeClass("active");
        $(this).addClass("active");
        $(".tab").removeClass("active");
        $("#"+tab).addClass("active");
      });

      /* ------------------------------ ê·œì¹™ ì²´í¬ë°•ìŠ¤ ------------------------------ */
      const ruleMap = {
        NightAfterNightOffRule: NightAfterNightOffRule,
        EssentialDuty:         EssentialDuty,
        NoConsecutiveOffRule:  NoConsecutiveOffRule,
        MinimalDutiesRule:     MinimalDutiesRule
      };
      const $ruleList = $("#ruleList");
      Object.keys(ruleMap).forEach(key=>{
        $ruleList.append(`<label><input type="checkbox" class="ruleCheck" value="${key}" checked> ${key}</label>`);
      });

      /* ------------------------------ ìƒì„± ë²„íŠ¼ ------------------------------ */
      $("#generateBtn").on("click", async function(){
        const people = $("#peopleInput").val().split(/\n+/).filter(Boolean);
        const optim  = $("#optimSelect").val();
        const requiredNights = $("#requiredNightsInput").val().split(/,\s*/).map(v=>parseInt(v,10)-1).filter(n=>!isNaN(n));
        const rules = $(".ruleCheck:checked").map((_,el)=> new ruleMap[el.value]()).get();

        $("#summary").html(`<p>ì¸ì› ${people.length}ëª… Â· ê·œì¹™ ${rules.length}ê°œ Â· ê¸°ì¤€ ${optim}</p>`);

        $("#genStatus").text("ìƒì„± ì¤‘...");
        await new Promise(r=>setTimeout(r,50)); // UI refresh

        const sched = new Schedule(31, people);
        const { solved, bestSched } = solve(sched, rules);
        if (!solved){ $("#genStatus").text("ì‹¤íŒ¨: í•´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); return; }

        $("#genStatus").text("ì™„ë£Œ!");
        renderResults(bestSched);
        $tabBtns.filter('[data-tab="results"]').trigger("click");
      });

      /* ------------------------------ ê²°ê³¼ ë Œë” ------------------------------ */
      function renderResults(sched){
        // í‘œ
        const header = `<tr><th>Day</th>${sched.people.map(p=>`<th>${p}</th>`).join("")}</tr>`;
        const rows = sched.grid.map((row,dIdx)=>{
          const cells = row.map(cell=>`<td>${cell?cell.label:'-'}</td>`).join('');
          return `<tr><td>${dIdx+1}</td>${cells}</tr>`;
        }).join('');
        $("#scheduleTable").html(`<table>${header}${rows}</table>`);

        // í†µê³„
        const hours = sched.personDutyHours;
        $("#statsBox").html(`
          <div class="stat">ìµœëŒ€ ${Math.max(...hours)}h</div>
          <div class="stat">ìµœì†Œ ${Math.min(...hours)}h</div>
          <div class="stat">ê²©ì°¨ ${Math.max(...hours)-Math.min(...hours)}h</div>
        `);
      }
    });
  </script>
</body>
</html>